name: CI

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]
    workflow_dispatch:

defaults:
    run:
        shell: bash

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

env:
    CARGO_TERM_COLOR: always
    CI: true
    GITHUB_ACTIONS: true

permissions:
    contents: read

jobs:
    # Code quality checks - always run
    quality:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v6
            - uses: dtolnay/rust-toolchain@1.93.1
              with:
                  components: llvm-tools, cargo, rustfmt, clippy
            - uses: jdx/mise-action@v3
              with:
                  install: true
                  cache: true
                  github_token: ${{ secrets.GITHUB_TOKEN }}

            - name: Check formatting
              run: just lint-rust

    tests:
        name: Tests
        runs-on: ubuntu-latest
        needs: quality
        strategy:
            matrix:
                features:
                    - postgresql
                    - sqlite
                    - mysql
                    - mongodb
                    - mssql
                    - encryption
                    - compression
        steps:
            - uses: actions/checkout@v6
            - uses: jdx/mise-action@v3
              with:
                  install: true
                  cache: true
                  github_token: ${{ secrets.GITHUB_TOKEN }}

            - name: Run Rust tests
              run: cargo nextest run --no-default-features --workspace --features ${{ matrix.features }}
              env:
                  CARGO_TERM_COLOR: never
                  TERM: dumb

    test-coverage:
        name: Test Coverage
        runs-on: ubuntu-latest
        needs: tests
        steps:
            - uses: actions/checkout@v6
            - uses: jdx/mise-action@v3
              with:
                  install: true
                  cache: true
                  github_token: ${{ secrets.GITHUB_TOKEN }}

            - name: Run Rust tests with coverage
              run: cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info --fail-under-lines 80 -- --test-threads=1
              env:
                  CARGO_TERM_COLOR: never
                  TERM: dumb

            - name: Generate lcov.info coverage report
              run: cargo llvm-cov --all-features --workspace --lcov --fail-under-lines 80 -- --test-threads=1
              env:
                  CARGO_TERM_COLOR: never
                  TERM: dumb

            - name: Upload coverage to Codecov
              uses: codecov/codecov-action@v4
              with:
                  token: ${{ secrets.CODECOV_TOKEN }}
                  file: lcov.info
                  flags: rust
                  name: rust-coverage
                  fail_ci_if_error: false

    build-binaries:
        name: Build Binaries
        runs-on: ubuntu-latest
        needs: tests
        steps:
            - uses: actions/checkout@v6
            - uses: jdx/mise-action@v3
              with:
                  install: true
                  cache: true
                  github_token: ${{ secrets.GITHUB_TOKEN }}

            - name: Build release binaries
              run: cargo build --release --all-features

            - name: Test binaries exist
              run: |
                  test -f target/release/dbsurveyor-collect
                  test -f target/release/dbsurveyor

            - name: Build no-default-features
              run: cargo build --release --no-default-features

            - name: Test no-default-features binaries exist
              run: |
                  test -f target/release/dbsurveyor-collect
                  test -f target/release/dbsurveyor

            - name: Build encryption-only
              run: cargo build --release --no-default-features --features encryption

            - name: Test encryption-only binaries exist
              run: |
                  test -f target/release/dbsurveyor-collect
                  test -f target/release/dbsurveyor
